<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments.html::head}"></head>
<body>
<div class="container">
	<h1 class="text-center">회원 조회</h1>

	<div th:if="${message}" class="alert alert-primary alert-dismissible success-alert" role="alert" id="success-alert">
		<p style="color: #ffffff" th:text="${message}"></p>
	</div>

	<!--버튼 그룹(돌아가기, 수정, 삭제)-->
	<div class="flex-box" style="margin: 20px 0">
		<button type="button" class="btn btn-secondary" style="width:80px" onclick="cancel()">돌아가기</button>
		<a type="button" class="btn btn-primary" th:href="@{'/member/edit/'+${memberDetail.id}}">수정</a>
		<form class="needs-validation" id="form" th:action="@{'/member/remove'}" method="post" novalidate>
			<input type="hidden" name="memberId" th:value="${memberDetail.id}"/>
			<button type="submit" class="btn btn-danger" onclick="return confirm('회원을 정말로 정말로 삭제할까요?')">삭제</button>
		</form>
	</div>

	<!--회원 정보-->
	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="id" style="text-align: end">회원 ID </label>
		<div class="input-group">
			<input id="id" type="text" th:value="${memberDetail.id}" class="form-control" style="width: 200px" disabled/>
		</div>
	</div>

	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="name">이름 </label>
		<div class="input-group">
			<input id="name" type="text" th:value="${memberDetail.name}" class="form-control" style="width: 200px" disabled/>
		</div>
	</div>

	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="email">이메일 </label>
		<div class="input-group">
			<input id="email" type="text" th:value="${memberDetail.email}" class="form-control" style="width: 200px"
			       disabled/>
		</div>
	</div>

	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="join-at">가입날짜</label>
		<div class="input-group">
			<input id="join-at" type="text" th:value="${memberDetail.joinAt}" class="form-control" style="width: 200px"
			       disabled/>
		</div>
	</div>

	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="level">레벨</label>
		<div class="input-group">
			<input id="level" type="text" th:value="${memberDetail.level}" class="form-control" style="width: 200px"
			       disabled/>
		</div>
	</div>

	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="card-total-count">소유카드 개수</label>
		<div class="input-group">
			<input id="card-total-count" type="text" th:value="${memberDetail.cardTotalCount}" class="form-control"
			       style="width: 200px" disabled/>
		</div>
	</div>

	<div class="flex-box" style="margin:10px 0; width: 330px; align-items: center; justify-content: space-between">
		<label for="card-total-price">소유카드 가격 총합</label>
		<div class="input-group">
			<input id="card-total-price" type="text" th:value="'$ '+${memberDetail.cardTotalPrice}" class="form-control"
			       style="width: 200px" disabled/>
		</div>
	</div>

	<div style="border-top: 1px solid black; margin: 20px 0"></div>


	<!--게임카드목록-->
	<div class="flex-box" style="justify-content: space-between; align-items: center; padding: 0 15px">
		<h3 style="margin: 5px 0;">소유 게임 카드</h3>
		<a type="button" class="btn btn-primary" th:href="@{'/card/enroll/member/'+${memberDetail.id}}" style="width: 150px">카드추가</a>
	</div>

	<table class="table table-striped table-hover">
		<thead>
		<tr>
			<th>ID</th>
			<th>게임종류</th>
			<th>타이틀</th>
			<th>일련번호</th>
			<th>가격</th>
			<th style="min-width: 70px"></th>
		</tr>
		</thead>
		<tbody>
		<tr th:if="${memberDetail.getGameCardsList().isEmpty()}">
			<td colspan="6">등록된 카드가 없습니다.</td>
		</tr>
		<tr th:each="card : ${memberDetail.getGameCardsList()}">
			<td th:text="${card.id}" class="card-id"></td>
			<td th:text="${card.game}"></td>
			<td th:text="${card.title}"></td>
			<td th:text="${card.serialNumber}"></td>
			<td th:text="'$'+${card.price}"></td>
			<td>
				<button class="remove-button">[삭제]</button>
			</td>
		</tr>
		</tbody>
	</table>
</div>
<footer th:replace="~{fragments.html::footer}"></footer>
<script th:replace="~{fragments.html::cancle-script(url='/')}"></script>
<script th:replace="~{fragments.html::close-alert-script (alertId='success-alert')}"></script>
<script type="application/javascript">

	$(document).ready(function () {
		$('.remove-button').click(function () {
			var cardId = $(this).closest('tr').find('.card-id').text();
			removeCard(cardId);
		});
	});

	function removeCard(id) {
		if (confirm('카드를 정말로 삭제할까요?')) {
			const memberId = [[${memberDetail.id}]];
			$.ajax({
				type: "POST",
				url: "/card/remove",
				contentType: "application/json",
				data: JSON.stringify({
					"cardId": id,
					"memberId": memberId
				}),
				success: function (response) {
					window.location.reload();
					alert("카드를 성공적으로 삭제하였습니다.");
				},
				error: function (xhr, status, error) {
					alert("카드 삭제가 실패하였습니다. 서버에 문의해주세요.")
				}
			});
		} else {
			return false;
		}
	}

</script>
</body>
</html>